<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>finalmap</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
    integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
    crossorigin=""
  />
  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
    integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
    crossorigin=""
  ></script>

  <style>
    body { margin: 0; padding: 0; }
    #map { height: 90vh; }
  </style>
</head>

<body>
  <div id="map"></div>

  <script>
    // ========= 1) 地図の初期化 =========
    const map = L.map("map", {
      center: [34.7, 135.3],
      zoom: 10,
    });

    L.control.scale().addTo(map);

    // 背景（OSM）
    const backgroundLayer = L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
    });

    // 背景（地理院 標準地図）
    const chiriinLayer = L.tileLayer("https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png", {
      maxZoom: 18,
      attribution: '&copy; <a href="https://maps.gsi.go.jp/development/ichiran.html">地理院タイル</a>',
    });

    // 初期表示は地理院
    chiriinLayer.addTo(map);

    // レイヤ切替（ここに後で overlay を追加していく）
    const layerControl = L.control.layers(
      {
        "地理院地図(標準)": chiriinLayer,
        "OpenStreetMap": backgroundLayer,
      },
      {}
    ).addTo(map);

    // ========= 2) マーカー（杉本・なかもず） =========
    const sugimoto = [34.592331, 135.505276];
    const nakamozu  = [34.544865, 135.506274];

    L.marker(sugimoto).bindPopup("杉本キャンパス").addTo(map);
    L.marker(nakamozu).bindPopup("なかもずキャンパスC棟").addTo(map);

    // ========= 3) 学校 GeoJSON（ポイント） =========
    // ファイル名は GitHub に置いたものと一致させる
    fetch("./P29-21_27.geojson")
      .then((res) => {
        if (!res.ok) throw new Error("学校GeoJSONが読み込めません: " + res.status);
        return res.json();
      })
      .then((json) => {
        const schoolLayer = L.geoJSON(json)
          .bindPopup((layer) => layer.feature?.properties?.P29_004 ?? "学校")
          .addTo(map);

        layerControl.addOverlay(schoolLayer, "学校（国土数値情報）");
      })
      .catch((err) => console.error(err));

    map.attributionControl.addAttribution(
      '<a href="https://nlftp.mlit.go.jp/ksj/gml/datalist/KsjTmplt-P29-v2_0.html">国土数値情報・学校データ</a>'
    );

    // ========= 4) 行政区域 GeoJSON（堺市中区だけ抽出） =========
    fetch("./N03-23_27_230101.geojson")
      .then((res) => {
        if (!res.ok) throw new Error("行政区域GeoJSONが読み込めません: " + res.status);
        return res.json();
      })
      .then((data) => {
        const filtered = data.features.filter(
          (f) => f.properties && f.properties.N03_004 === "堺市中区"
        );

        const areaLayer = L.geoJSON(filtered, {
          style: { weight: 2, opacity: 0.9, fillOpacity: 0.15 },
        })
          .bindPopup((layer) => layer.feature?.properties?.N03_004 ?? "行政区域")
          .addTo(map);

        layerControl.addOverlay(areaLayer, "行政区域（堺市中区）");

        // 行政区域が表示できたら、その範囲へ寄せる
        const b = areaLayer.getBounds();
        if (b.isValid()) map.fitBounds(b);
      })
      .catch((err) => console.error(err));

    // ========= 5) OSRM APIでルート（ライン）を取得して描画 =========
    // ※OSRMは「経度,緯度」の順！
    const osrmUrl =
      "https://routing.openstreetmap.de/routed-car/route/v1/driving/" +
      "135.505276,34.592331;135.506274,34.544865" +
      "?geometries=geojson&overview=full";

    async function addRouteLayer() {
      const response = await fetch(osrmUrl);
      if (!response.ok) throw new Error("OSRM API 取得失敗: " + response.status);

      const json = await response.json();
      if (!json.routes || json.routes.length === 0) throw new Error("OSRMのroutesが空です");

      const routeGeo = json.routes[0].geometry;

      const routeLayer = L.geoJSON(routeGeo, {
        style: {
          color: "#FF00FF",
          weight: 6,
          opacity: 0.65,
        },
      }).addTo(map);

      layerControl.addOverlay(routeLayer, "ルート（OSRM API）");

      // ルート全体が見えるように調整（行政区域fitBoundsより優先したいならここを有効に）
      const rb = routeLayer.getBounds();
      if (rb.isValid()) map.fitBounds(rb);
    }

    addRouteLayer().catch((err) => console.error(err));

    // ========= 6) Overpass APIで「amenity=shelter」を取得してポイント追加 =========
// Overpass API（OSMデータ検索）: :contentReference[oaicite:2]{index=2}
// amenity=shelter タグ: :contentReference[oaicite:3]{index=3}

// だいたい堺市中区〜周辺を覆うBBox（南,西,北,東）
// 必要なら少し広げてOK
const bbox = "34.50,135.43,34.62,135.56";

// Overpass QL（node/way/relation をまとめて取得。way/relation は center を返す）
const overpassQuery = `
[out:json][timeout:25];
(
  node["amenity"="shelter"](${bbox});
  way["amenity"="shelter"](${bbox});
  relation["amenity"="shelter"](${bbox});
);
out center;
`;

// URLにエンコードして投げる（GETでもOK）
const overpassUrl =
  "https://overpass-api.de/api/interpreter?data=" + encodeURIComponent(overpassQuery);

async function addShelterLayer() {
  const res = await fetch(overpassUrl);
  if (!res.ok) throw new Error("Overpass API 取得失敗: " + res.status);

  const data = await res.json();

  // 受け取った要素を Leaflet のマーカーにする
  const markers = [];
  for (const el of data.elements) {
    // nodeは lat/lon、way/relation は center.lat/lon
    const lat = el.lat ?? el.center?.lat;
    const lon = el.lon ?? el.center?.lon;
    if (lat == null || lon == null) continue;

    const name = el.tags?.name ?? "(名称なし)";
    const shelterType = el.tags?.shelter_type ?? "";
    const operator = el.tags?.operator ?? "";

    const popupHtml = `
      <b>シェルター/避難所候補</b><br>
      名称: ${name}<br>
      type: ${shelterType}<br>
      管理: ${operator}<br>
      <small>source: OpenStreetMap (Overpass)</small>
    `;

    markers.push(L.marker([lat, lon]).bindPopup(popupHtml));
  }

  const shelterLayer = L.layerGroup(markers).addTo(map);
  layerControl.addOverlay(shelterLayer, "避難所/シェルター（Overpass）");

  // 0件でも動作はOK。件数だけログで確認できるようにする
  console.log("Shelter count:", markers.length);
}

addShelterLayer().catch((err) => console.error(err));

  </script>
</body>
</html>
